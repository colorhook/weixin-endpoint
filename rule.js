/*!
 * @author hk1k
 * @module defaultRules
 */
var request = require('request');

module.exports = function(webot) {
    
    webot.set('32like', ['è¯·è®°ä½æˆ‘ï¼Œè¿™å°±æ˜¯æˆ‘çš„é©¬ç”²', 'ç‚¹32ä¸ªèµ', 'ğŸ‘']);
    
    webot.set('/^(\\?|ï¼Ÿ)+$/', 'æœ‰ä»€ä¹ˆå¯ä»¥å¸®å¿™çš„å—');

    webot.set('/^åƒ+$/', 'ä½ æ˜¯çŒªå•Šï¼Œå°±çŸ¥é“åƒ');

    webot.set('/^å±+$/', 'ä½ æ˜¯å‚»é¸Ÿï¼Œé‰´å®šå®Œæ¯•');

    webot.set('/^[.ã€‚]+$/i', 'å¹²å˜›æ— è¯­');

    webot.set('/^help$/i', 'æœ‰ä»€ä¹ˆå¯ä»¥å¸®å¿™çš„å—');

    webot.set('/^ä½ æ˜¯(è°|ä»€ä¹ˆ)*([?|ï¼Ÿ]*)/', ["æˆ‘æ˜¯æ™ºæ…§ä¸ç¾ä¸½çš„åŒ–èº«", "è¯·å«æˆ‘å¤©ä½¿", "æˆ‘æ˜¯é£éªšçš„å°ç§˜ä¹¦", "å‡è£…ä¸åœ¨"]);

    webot.set('/^(ä½ ä¸ª|æˆ‘)*(åäºº|åè›‹|ç¬¨è›‹|sb|äºŒè´§|2è´§|å‚»x|å¤§å‚»|ç“œå¨ƒ|å°æ ·|æ“¦|ä½ å¦¹çš„?|ç®—?(æ±‚|çƒ|é€‘)|å»|å‚»|å‚»é¸Ÿ|ç…ç¬”|shabi|å‚»æ¯”|å‚»é€¼|ç¥ç»|(ç¥ç»|è›‡ç²¾)ç—…|æ·±äº•å†°|æ“|è‰|æ—¥|å±®|è‰¹)([\.!ï¼ã€‚]*)$/i', ["ä½ ä¸ªå‚»X", "ä¸è®¸éª‚äºº", "ä½ æ˜¯ç¥ç»ç—…å•Š", "æ·±äº•å†°"]);

    webot.set('ä¸ºäººæ°‘æœåŠ¡', ["ä½ æ˜¯æ´»é›·é”‹"]);

    webot.set('æ¯›ä¸»å¸­ä¸‡å²', 'ä¸‡å²ä¸‡å²ä¸‡ä¸‡å²');

    webot.set('é›·é”‹', 'è¯·å«æˆ‘çº¢é¢†å·¾');

    webot.set('çº¢é¢†å·¾', 'è¯·å«æˆ‘é›·é”‹');

    webot.set('æ²¡äº‹', 'ä½ çœŸæ— èŠ');

    webot.set('/^(å¹²å˜›|æ€ä¹ˆäº†|å’‹å•¦|å’‹äº†|æ€ä¹ˆå•¦|what|æœ‰?ä»€ä¹ˆäº‹)/', 'æ²¡äº‹ï¼Œå˜»å˜»');

    webot.set('å¸…å“¥', 'æˆ‘åœ¨å‘¢');

    webot.set('ç¾å¥³', 'ä»€ä¹ˆäº‹ï¼Ÿ');

    webot.set('çˆ±', 'æ¯å¤©è¯´ä¸€é');

    webot.set('å–œæ¬¢', 'æˆ‘å°±çŸ¥é“ä½ å–œæ¬¢æˆ‘');

    webot.set('å–œæ¬¢ä½ ', 'æˆ‘å°±çŸ¥é“ä½ å–œæ¬¢æˆ‘');

    webot.set('çˆ±ä½ ', 'æˆ‘ä¹Ÿæ˜¯');

    webot.set('/^é’“é±¼å²›/', 'é’“é±¼å²›æ˜¯ä¸­å›½çš„');

    webot.set('/ä½ ?å¥½?(nb|nx|ç‰›å‰|æ£’|å‰å®³|èµ|great|ç‰›é€¼)å•Š?([\\.!ï¼ã€‚]*)$/', ['è°¢è°¢å¤¸å¥–', 'å½¼æ­¤å½¼æ­¤', 'è¿˜éœ€è¦åŠªåŠ›']);

    webot.set('/^(å“ˆ(å“ˆ*)|å‘µ(å‘µ*)|(ä¹–*)|ha(ha)*|he(he)*|ha|he)([\.!ï¼ã€‚]*)$/i', ['ç¬‘è€Œä¸è¯­', 'å¹²å˜›å‚»ç¬‘','ğŸ˜Š', 'ğŸ˜‚']);
    
    webot.set('/^(yes|Y|éå¸¸å¥½|love|like|ğŸ‘|æœ‰è¶£|ç¥å¥‡|xixi|å˜»å˜»|å¥½ç©|ä¸é”™|æ”¯æŒ|ç‚¹?èµ|æœ‰ç‚¹æ„æ€|è¿˜è¡Œ|å‡‘åˆ)å•Š?$/i', ['å˜»å˜»', 'è°¢è°¢é¼“åŠ±']);
    
    webot.set('/^(no|N|å¼±|å¼±çˆ†äº†?|ä¸è¡Œ|è®¨åŒ|åƒåœ¾|æŒ«|å·®åŠ²?|å¤ªå·®äº†?)å‘€?$/i', ['ä¼¤å¿ƒ', 'çœ‹æ¥è¿˜éœ€è¦å¾ˆåŠªåŠ›æ‰è¡Œ']);
    
    webot.set('/^æˆ‘?å¥½?(ä¼¤å¿ƒ|éš¾è¿‡|ç”Ÿæ°”|æ°”æ„¤|æ„¤æ€’|sad)ä¸­?/', ['åˆ«éš¾è¿‡', 'å¼€å¿ƒç‚¹', 'ğŸ˜¢']);
    
    webot.set('/^æˆ‘?å¥½?(å¼€å¿ƒ|æ— èŠ|é«˜å…´|å¿«ä¹|happy)/', ['ä¸¾æ¯', 'å–ä¸€æ¯', 'å”±é¦–æ­Œ', 'ğŸ˜„', 'ğŸ˜Š']);
    
    webot.set('/ä½ (.*)å‚»/', ['ä¸€ç‚¹ç‚¹', 'æ²¡ä½ èªæ˜', 'æˆ‘å“ªé‡Œé”™äº†ï¼Ÿ']);

    webot.set('/^(ç™¾åº¦|baidu)$/i', 'ä½ è¦æœä»€ä¹ˆ?');

    webot.set('/^(è…¾è®¯|qq)/i', 'ä½ æƒ³æ‰“ä¼é¹…ğŸ§å—?');

    webot.set('/^(alibaba|é˜¿é‡Œ|é˜¿é‡Œå·´å·´)$/i',['èŠéº»å¼€é—¨', 'å‘Šè¯‰æˆ‘å¼ºç›—åœ¨å“ªé‡Œ']);

    webot.set('/(ç¡è§‰|æ™šå®‰|å“ˆæ¬ |æ‰“å“ˆæ¬ )/', ['å¿«å»ä¼‘æ¯', 'æ—©ç‚¹ä¼‘æ¯']);

    webot.set('èµ·åºŠ', 'å†ç¡ä¸€ä¼šå˜›');

    webot.set('/(æ—©å®‰|æ—©ä¸Šå¥½|morning)/', ['ä½ çœŸæœ‰ç¤¼è²Œ']);

    webot.set('/é¥¿/', ['ç”¨æ·˜ç‚¹ç‚¹å«ä¸ªå¤–å–', 'å»å¤–å©†å®¶åƒä¸ªé¥­å§']);

    webot.set('/æ¸´/', 'å¤šå–æ°´');

    webot.set('/å¥½?ç´¯äº†?/', ['æ—©ç‚¹ä¼‘æ¯', 'ç©ä¼šæ¸¸æˆå§']);

    webot.set('/^ä¸Š(ç­|è¯¾)$/', 'åˆ«è¿Ÿåˆ°');

    webot.set('/^ä¸‹(ç­|è¯¾)$/', 'è®°å¾—å¸¦å¥½ä¸œè¥¿');

    webot.set('/å…¬äº¤/', 'è¦æŸ¥æ‰¾å…¬äº¤è·¯çº¿å—');

    webot.set('æ¸…æ˜èŠ‚', 'ç¥ä½ èŠ‚æ—¥å¿«ä¹');

    webot.set('/^(hi|hello|hey|ä½ å¥½|æ‚¨å¥½)([\.!ï¼ã€‚]*)/i', function(){
      var now = new Date();
      var hour = now.getHours();
      var timeSecene = (hour < 12) ? 'æ—©ä¸Š' : ((hour < 18) ? 'ä¸‹åˆ' : 'æ™šä¸Š');
      if(Math.random() > 0.5){
        return ['ä½ å¥½','ä»Šå¤©å¿ƒæƒ…ä¸é”™!','æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼Ÿ','æœ‰ä»€ä¹ˆäº‹ï¼Ÿ'];
      }
      if(hour >= 22 || hour < 2){
        return 'è¿™ä¹ˆæ™šäº†è¿˜ä¸ç¡?';
      }else if(hour < 5){
        return 'å¥½æ—©å•Šï¼Œå¤©è¿˜æ²¡äº®å‘¢ï¼';
      }else{
        return timeSecene + 'å¥½';
      }
    });

    webot.set('/^(éå¸¸|å¾ˆ|å¾ˆæ˜¯)*(è°¢|è°¢è°¢|æ„Ÿè°¢|è°¢äº†|è°¢è°¢ä½ |è°¢å’¯|è°¢è°¢å’¯|è°¢è°¢å•¦|è°¢å•¦|è°¢è°¢æ‹‰|è°¢æ‹‰|ä½ çœŸæ£’)([\.!ï¼ã€‚]*)/', ['ä½ çœŸå®¢æ°”', 'ç”­å®¢æ°”', 'å¾ˆé«˜å…´ä½ ä¼šè¿™ä¹ˆè¯´']);
    
    
    webot.set('/^(æ—¥æœŸ|date)$/', function(){
      var now = new Date();
      var year = now.getFullYear();
      var month = now.getMonth();
      var date = now.getDate();
      var str = 'ä»Šå¤©æ˜¯' + year + 'å¹´' + (month + 1) + 'æœˆ' + date + 'æ—¥';
      return str;
    });
    
    ['/^(ç°åœ¨)*(å‡ ç‚¹|ä»€ä¹ˆæ—¶é—´|çš„*æ—¶é—´)([äº†å•¦æ‹‰]*)([?|ï¼Ÿ]*)$/', 'now', 'time'].forEach(function(item){
      webot.set(item, function(){
        var now = new Date();
        var hour = now.getHours();
        var minute = now.getMinutes();
        return 'ç°åœ¨æ˜¯' + hour + 'ç‚¹' + minute + 'åˆ†';
      });
    });


    ['/^(ä»Šå¤©)?å¤©æ°”(æ€ä¹ˆæ ·|å¦‚ä½•)?([?|ï¼Ÿ]*)$/i', 'weather'].forEach(function(item){
      webot.set(item, function(){
        return 'æˆ‘æƒ³å¤©æ°”ä¸é”™å§ã€‚æ¯å¤©éƒ½æ˜¯å¥½å¤©æ°”!';
      });
    });

    ['/^(ä»Šå¤©)*(æ˜ŸæœŸå‡ )([äº†å•¦æ‹‰]*)([?|ï¼Ÿ]*)$/', 'æ˜ŸæœŸ', 'day'].forEach(function(item){
        webot.set(item, function(){
          var now = new Date();
          var day = now.getDay();
          var arr = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'å¤©'];
          return 'ä»Šå¤©æ˜ŸæœŸ' + arr[day - 1];
        });
    });

    webot.set('/^(news|æ–°é—»)$/i', function(){
      return 'æƒ³çœ‹æ–°é—»å•Šï¼Œè¯·æ‰“å¼€ç½‘æ˜“æ–°é—»å®¢æˆ·ç«¯ã€‚';
    });

    webot.set('/^(kfc|è‚¯å¾·åŸº)$/i', function(){
      return 'é™„è¿‘æ²¡æœ‰è‚¯å¾·åŸº';
    });

    webot.set('/^(M|éº¦å½“åŠ³)$/i', function(){
      return 'è¯·ä½¿ç”¨æ·˜ç‚¹ç‚¹';
    });

    webot.set('/^(starbucks|æ˜Ÿå·´å…‹)$/i', function(){
      return 'æƒ³å’Œå’–å•¡å—ï¼Œæˆ‘ä»¬ä¸€èµ·å»å¦‚ä½•?â˜•ï¸';
    });

    webot.set('æ”¯ä»˜å®', function(){
      return ['è¿™æ˜¯ä¸€æ¬¾å¥½åº”ç”¨', 'äº¤ä¸ªæ°´ç”µç…¤å§', 'æ‰‹æœºæ¬ è´¹è®°å¾—ç”¨å®ƒå……å€¼', 'æ‰“è½¦ç”¨æ”¯ä»˜å®ä»˜æ¬¾', 'ä¾¿åˆ©åº—å¯ä»¥ç”¨æ”¯ä»˜å®æ¡ç æ”¯ä»˜'];
    });

    webot.set('/ä½™é¢å®?/', function(){
      return ['ä½ ä»Šå¤©çš„æ”¶ç›Šæœ‰å¤šå°‘', 'è½¬å…¥10000å‹å‹æƒŠ'];
    });

    ['æ­Œæ›²', 'å¬æ­Œ', '/music/i', 'éŸ³ä¹'].forEach(function(item){
      webot.set(item, 'æ‰“å¼€è™¾ç±³å¬éŸ³ä¹');
    });

    ['/^çœ‹?ç”µå½±$/', 'ç”µå½±é™¢', 'ç”µå½±ç¥¨', 'æ–°ç‰‡', '/å¤§ç‰‡$/', 'ä¸Šæ˜ ', 'å¥½è±å', 'åŠ¨ç”»ç‰‡', '/^3d$/i'].forEach(function(item){
      webot.set(item, ['ä½¿ç”¨è±†ç“£ç”µå½±æŸ¥æ‰¾æœ€è¿‘ä¸Šæ˜ çš„ç”µå½±å§', 'ä½ å»ä¹°ç¥¨ï¼Œè®°å¾—ç”¨æ”¯ä»˜å®ä»˜æ¬¾']);
    });

    ['æ–°æ¬¾', 'çˆ†æ¬¾', 'è´­ç‰©', 'ä¹°ä¸œè¥¿', '/^shop(ping)?$/i', 'æ·˜å®', 'å¤©çŒ«', 'ä¸€æ·˜', 'äº¬ä¸œ', 'æ˜“è®¯', 'å‡¡å®¢', 'å½“å½“', 'äºšé©¬é€Š', '/^(taobao|tmall|etao|jd|jingdong|xiyun|fanke|dangdang|yamaxun|amazon)$/i'].forEach(function(item){
      webot.set(item, ['æ‰“å¼€æ·˜å®å®¢æˆ·ç«¯è´­ç‰©', 'è´­ç‰©ä¸Šå¤©çŒ«', 'åˆæƒ³å‰æ‰‹äº†ï¼Ÿ']);
    });

    ['ç¬‘è¯', 'è®²ç¬‘è¯', 'å†·ç¬‘è¯'].forEach(function(item){
      webot.set(item, ['æˆ‘ä¸ä¼šè®²ç¬‘è¯', 'ä½ è®²ä¸€ä¸ªè¯•è¯•']);
    });

    ['è¡¨æƒ…'].forEach(function(item){
      webot.set(item, 'éšæœºç»™ä½ ä¸€ä¸ªè¡¨æƒ…');
    });

    ['æ¸¸æˆ', 'å°æ¸¸æˆ', 'æ‰‹æ¸¸', '/^game$/i'].forEach(function(item){
      webot.set(item, 'æ‰¾åˆ°ä¸€äº›æ¸¸æˆï¼Œæ‹¿å»ä¸è°¢');
    });

    ['å»å“ªå„¿', 'å¹²ä»€ä¹ˆ', 'å»å“ª', 'å»å“ªç©', 'ç©ä»€ä¹ˆ', 'æ—…æ¸¸'].forEach(function(item){
      webot.set(item, 'å·²ç»æ‰¾åˆ°äº†ä¸€äº›ä¼˜æƒ é—¨ç¥¨');
    });

    ['å¾®ä¿¡', 'æ¥å¾€', 'çŸ¥ä¹', 'å¾®åš', 'èšåˆ’ç®—', 'ä¼˜é…·'].forEach(function(item){
      webot.set(item, 'è¿™äº›éƒ½æ˜¯çƒ­é—¨çš„äº’è”ç½‘åº”ç”¨');
    });

    ['/è‹äº•ç©º/', 'æ·«è¡', '/^æ‰“ä½ /', '/sex/', '/(æ¯›|é»„)ç‰‡/', '/^av$/i', 'åå…«ç¦', '18ç¦'].forEach(function(item){
      webot.set(item, ['å¹´è½»äººè¦å­¦å¥½', 'ä½ åœ¨è¯´ä»€ä¹ˆï¼Œå…¶å®æˆ‘ä¸æ‡‚è¿™äº›ã€‚']);
    });

    ['éŸ©å‰§', 'éŸ©ç‰‡', 'éŸ©å›½'].forEach(function(item){
      webot.set(item, ['è¿™é‡Œæ²¡æœ‰æ¬§å·´', 'æ¥ä»½æ³¡èœæ€ä¹ˆæ ·']);
    });

    ['å°æ—¥æœ¬', 'æ—¥æœ¬', 'æ—¥æœ¬äºº', 'æ—¥ç³»'].forEach(function(item){
      webot.set(item, 'è¯·ä¸è¦è¾“å…¥è¿ç¦è¯');
    });
    
    webot.set('image', {
      pattern: function(info) {
        return info.is('image');
      },
      handler: function(info, next) {
        next(null, 'å›¾ç‰‡å¾ˆå¥½çœ‹ï¼Œå¯æƒœæˆ‘æš‚æ—¶çœ‹ä¸æ‡‚');
      },
    });

    webot.set('other type', {
      pattern: function(info) {
        return !info.is('text');
      },
      handler: function(info) {
        info.flag = true;
        if (info.is('voice')) {
          return 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶è¿˜ã€Œå¬ã€ä¸æ‡‚äººè¯ï¼Œè¯·ç”¨æ–‡å­—ä¸æˆ‘äº¤æµå§';
        }
        return 'æš‚æ—¶è¿˜ä¸çŸ¥é“æ€ä¹ˆå¤„ç†è¿™ç§æ¶ˆæ¯è¯¶...';
      },
    });

    webot.set(/^å»ºè®®(.{3})/, function(info) {
      info.flag = true;
      return 'ä½ çš„æ„è§å·²ç»æ”¶åˆ°ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚[å¾®ç¬‘]';
    });

    

    var reg_search_cmd = /^(ç™¾åº¦|baidu)(ä¸€ä¸‹|æœç´¢|search)?\s*(.+)/i;

    function do_search(info, next, q) {
      if(!q){
         q = info.text.match(reg_search_cmd)[3];
      }
      request('http://www.baidu.com/s?wd=' + encodeURIComponent(q), function(err, response, res) {
        if (err || !res) return next(null, 'ç°åœ¨æš‚æ—¶æ— æ³•æœç´¢ï¼Œå¾…ä¼šå„¿å†æ¥å¥½å—ï¼Ÿ');

        // ä¸ºäº†å…¼å®¹ä¸åŒç¼–ç ï¼Œres é»˜è®¤æ˜¯ä¸€ä¸ª Buffer
        // è°ƒç”¨ toString æ–¹æ³•ï¼Œè½¬æ¢ä¸º utf-8 çš„å­—ç¬¦ä¸²
        res = res.toString();
        
        var reg_h3t = /<h3 class="t">\s*(<a.*?>.*?<\/a>).*?<\/h3>/gi;
        var links = [];
        var i = 1;

        while (true) {
          var m = reg_h3t.exec(res);
          if (!m || i > 5) break;
          links.push(i + '. ' + m[1]);
          i++;
        }


        var ret;
        if (links.length) {
          ret = 'åœ¨ç™¾åº¦æœç´¢åˆ°ä»¥ä¸‹ç»“æœï¼š\n' + links.join('\n');
          ret = ret.replace(/\s*data-click=".*?"/gi,  '');
          ret = ret.replace(/\s*onclick=".*?"/gi,  '');
          ret = ret.replace(/\s*target=".*?"/gi,  '');
          ret = ret.replace(/<em>(.*?)<\/em>/gi,  '$1');
          ret = ret.replace(/<font.*?>(.*?)<\/font>/gi,  '$1');
          ret = ret.replace(/<span.*?>(.*?)<\/span>/gi,  '$1');
        } else {
          ret = 'æœä¸åˆ°ä»»ä½•ç»“æœå‘¢';
        }

        next(null, ret);
      });
    }

    webot.set('search', {
      'pattern': reg_search_cmd,
      'handler': do_search
    });
    


    webot.afterReply(function(info, next) {
      if(info.err == 404){
        do_search(info, next, info.text);
      }else{
        next();
      }
    });


}
